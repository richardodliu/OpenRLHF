\newpage
\appendix

\section{Appendix Roadmap}

This appendix collects supplementary material for the main paper.
\begin{itemize}
    \item \textbf{Implementation divergence and anchoring.} \Cref{app:mismatch} summarizes common sources of rollout--training mismatch and
    our anchoring choice. \Cref{app:ppo-clip-leak} explains why PPO clipping can leak gradients under implementation divergence.

    \item \textbf{REINFORCE Max details.} \Cref{app:rloo-proof} summarizes standard properties of the leave-one-out (RLOO) baseline.
    \Cref{app:gamma-one} gives a brief justification for setting $\gamma = 1.0$ under sparse terminal rewards. \Cref{app:numerical} and
    \Cref{app:uniform-scale} provide implementation-oriented numerical safeguards and an optional uniform scale mode.

    \item \textbf{REINFORCE Pro proofs and variants.} \Cref{app:prefix-proof} provides the complete proof of
    \Cref{thm:prefix-tighter}. \Cref{app:mask-variants} collects additional prefix masking variants compatible with the ratio setup in the
    main text.
\end{itemize}

\section{Implementation Divergence and Trust-Region Anchoring}

\subsection{Details on Off-Policy Mismatch in LLM-RL}
\label[appsec]{app:mismatch}

Modern LLM-RL pipelines decouple inference from training: rollouts are produced by an inference engine (e.g., vLLM or SGLang) under the
rollout policy $\piroll$, while gradient updates are computed in a separate training stack under the training policy $\pitheta$. This
architectural separation can introduce off-policy mismatch even when parameters are nominally aligned.

\paragraph{Mismatch Sources}
Common sources of mismatch include backend discrepancies (different attention kernels, precision formats, or reduction order), MoE routing
discontinuities (Top-$K$ routing can flip under small perturbations), and distributed staleness (actor--learner lag between rollout and
consumption). These effects can compound autoregressively over long horizons and lead to volatile per-token ratios.

\paragraph{Anchoring and the Apparent Three-Distribution Structure}
Practical pipelines can exhibit an apparent three-distribution structure: (i) a rollout engine generates tokens according to an
inference-time distribution, (ii) a training framework computes gradients under $\pitheta$, and (iii) some implementations recompute the
behavior log-probabilities inside the training stack, yielding a recomputed anchor that can differ from the true rollout distribution even
when parameters are identical. Importantly, this third object is not an additional policy in our theory; it is an alternative
implementation-time anchor for the denominator of $\rho_t$.

\paragraph{Trust Region Setup}
\citet{qi2026rethinkingtrustregionllm} argue that the trust region (and hence the denominator of the importance ratio) must be defined with
respect to the \emph{original} behavior policy that generated the data, rather than a recomputed policy distribution evaluated inside the
training stack. Accordingly, we denote this rollout-time behavior policy by $\piroll$, define
$\rho_t := \pitheta(y_t\mid c_t) / \piroll(y_t\mid c_t)$, and assume access to rollout-time cached log-probabilities
$\log \piroll(y_t\mid c_t)$. The theoretical development therefore involves only the policy pair $(\piroll,\pitheta)$, consistent with
long-horizon trust-region analyses for LLM-RL (e.g., \citet{li2025trm}).

\paragraph{PPO-Style $\piold$ Mismatch}
In PPO-style implementations, the rollout snapshot used to generate data is often denoted by $\piold$; within a single policy update, this
snapshot coincides with the data-generating policy $\piroll$ (so $\piold \equiv \piroll$ in our notation). We use $\piold$ only for
implementation mapping and keep the theory in terms of $(\piroll,\pitheta)$.

\subsection{Why PPO Clipping Can Leak Gradients Under Mismatch}
\label[appsec]{app:ppo-clip-leak}

\paragraph{PPO Clipped Surrogate}
PPO~\citep{schulman2017proximal} constrains policy updates by clipping the per-token importance ratio. In the notation of this paper, the
ratio is
\begin{equation*}
    \rho_t := \frac{\pitheta(y_t \mid c_t)}{\piroll(y_t \mid c_t)}.
\end{equation*}
The clipped surrogate takes the form
\begin{equation*}
    \mathcal{L}^{\mathrm{CLIP}}(\pitheta)
    = \E_{\piroll}\!\left[\sum_{t=1}^{T}\min\!\Big(
        \rho_t \hat{A}_t,\;
        \mathrm{clip}(\rho_t, 1-\epsilon_{\mathrm{clip}}, 1+\epsilon_{\mathrm{clip}})\,\hat{A}_t
    \Big)\right],
\end{equation*}
where $\hat{A}_t$ is an advantage estimator and $\epsilon_{\mathrm{clip}}>0$ is the clipping threshold.

\paragraph{Asymmetry and Gradient Leakage}
The clipping operator is asymmetric in the sign of $\hat{A}_t$. When $\hat{A}_t<0$ and $\rho_t \gg 1+\epsilon_{\mathrm{clip}}$, the
unclipped term can still be selected:
\begin{equation*}
    \rho_t > 1+\epsilon_{\mathrm{clip}},\ \hat{A}_t<0
    \quad\Longrightarrow\quad
    \rho_t\hat{A}_t < (1+\epsilon_{\mathrm{clip}})\hat{A}_t
    = \mathrm{clip}(\rho_t, 1-\epsilon_{\mathrm{clip}}, 1+\epsilon_{\mathrm{clip}})\,\hat{A}_t,
\end{equation*}
hence $\min(\cdot)$ returns $\rho_t\hat{A}_t$. In this regime, the gradient magnitude still scales with $\rho_t$, so extremely large ratios
can produce large updates even though they lie far outside the nominal trust region.

\paragraph{Why This Is Benign in Standard RL}
In classical on-policy settings, large ratios typically reflect genuine policy changes that over-emphasize low-quality actions; keeping the
unclipped penalty for $\hat{A}_t<0$ can be desirable as it discourages such actions.

\paragraph{Failure Mode Under Implementation Divergence}
In LLM-RL pipelines with inference--training mismatch, large ratios can arise from numerical or backend discrepancies rather than meaningful
policy improvements. For example, a routing discontinuity in a Mixture-of-Experts model can yield a token $v$ such that
\begin{equation*}
    \piroll(v\mid c_t) \approx 0.001,
    \qquad
    \pitheta(v\mid c_t) \approx 0.9,
    \qquad
    \rho_t \approx 900.
\end{equation*}
Such spikes reflect implementation-level divergence and can induce a massive, erroneous gradient contribution under the unclipped branch
when $\hat{A}_t<0$. This motivates using a detached trust-region mask to discard mismatched tokens or trajectories rather than relying on a
token-level clipping heuristic.

\section{REINFORCE Max: Supplementary Details}

\subsection{Leave-One-Out Baseline Properties}
\label[appsec]{app:rloo-proof}

We summarize standard properties of the leave-one-out baseline estimator used in \Cref{sec:reinforce-max}; see
\citet{ahmadian2024back} for a detailed treatment.

\begin{remark}[Properties of the Leave-One-Out Baseline]
\label{rem:rloo-variance}
Fix a prompt $x$ and draw $n \ge 2$ i.i.d.\ responses $\{y^{(1)}, \ldots, y^{(n)}\} \sim \pitheta(\cdot|x)$ with rewards
$r_i = R(x, y^{(i)})$. Let
\begin{equation*}
    f_i = \nabla_\theta \log P^{\pitheta}(y^{(i)} \mid x)
\end{equation*}
denote the trajectory score function for sample $i$, and define the per-sample policy gradient contribution with baseline $b$ as
$g_i(b) = (r_i - b) f_i$. With the leave-one-out baseline $b_i = \frac{1}{n-1}\sum_{j \neq i} r_j$, the estimator
\begin{equation*}
    \hat{g} = \frac{1}{n}\sum_{i=1}^{n} g_i(b_i)
\end{equation*}
satisfies:
\begin{enumerate}
    \item \textbf{Unbiasedness:} $\E[\hat{g}] = \nabla_\theta J(\pitheta)$.
    \item \textbf{Baseline independence:} For each $i$, $b_i$ is independent of $(r_i, f_i)$; in particular, $\E[b_i f_i] = 0$ and
    $\Cov(f_i, b_i) = 0$.
    \item \textbf{Mean-baseline scaling:} Let $b^{\mathrm{mean}} = \frac{1}{n}\sum_{j=1}^{n} r_j$ and
    $\hat{g}^{\mathrm{mean}} = \frac{1}{n}\sum_{i=1}^{n}(r_i - b^{\mathrm{mean}}) f_i$. Then deterministically
    $\hat{g}^{\mathrm{mean}} = \frac{n-1}{n}\hat{g}$, and hence $\E[\hat{g}^{\mathrm{mean}}] = \frac{n-1}{n}\nabla_\theta J(\pitheta)$.
    \item \textbf{Second-moment decomposition:} Let $\mu(x) = \E[r_i \mid x]$ and $\sigma^2(x) = \Var(r_i \mid x)$. Then
    $\Var(b_i \mid x) = \sigma^2(x)/(n-1)$, and
	    \begin{equation*}
	        \E\!\big[(r_i - b_i)^2 f_i f_i^\top \mid x\big]
	        = \E\!\big[(r_i - \mu(x))^2 f_i f_i^\top \mid x\big] + \Var(b_i \mid x)\, \E[f_i f_i^\top \mid x].
	    \end{equation*}
\end{enumerate}
\end{remark}

\begin{remark}[Relationship Between the Two Estimators]
The deterministic proportionality $\hat{g}^{\mathrm{mean}} = \frac{n-1}{n}\hat{g}$ implies that the mean-baseline estimator is a
rescaled (and therefore biased) version of the leave-one-out estimator: its smaller raw variance is entirely due to the constant scaling
factor. In practice, this shrinkage can be absorbed into the learning rate, but it breaks exact unbiasedness. The main advantage of the
leave-one-out baseline is that $b_i$ is independent of sample $i$, which simplifies moment calculations and avoids self-correlation terms
that arise when the baseline depends on $r_i$.
\end{remark}

\begin{remark}
The leave-one-out baseline is equivalent to the leave-one-out control variate from the classical REINFORCE literature~\citep{williams1992simple}. In the LLM-RL setting with $n$ samples per prompt, each sample's baseline is independent of its own trajectory, making it particularly well-suited for group-based sampling strategies.
\end{remark}

\noindent Proofs are omitted; see \citet{ahmadian2024back}.



\subsection{Optimality of \texorpdfstring{$\gamma = 1.0$}{gamma = 1.0}}
\label[appsec]{app:gamma-one}

\begin{remark}[On Setting $\gamma = 1.0$ for Sparse Terminal Rewards]
When the extrinsic reward is sparse (assigned only at the final token) and the target objective is the undiscounted return
$J(\pitheta) = \E[R(x,y)]$, it is standard to set $\gamma = 1.0$ so that the token-level return matches the terminal reward at every
position. Choosing $\gamma < 1$ instead corresponds to optimizing a discounted objective that downweights earlier tokens; see
\citet{williams1992simple} for background on REINFORCE.
\end{remark}


\subsection{Numerical Stability}
\label[appsec]{app:numerical}

The adaptive normalization (\Cref{sec:adaptive-norm}) includes several safeguards:

\begin{remark}[Numerical Thresholds vs.\ Divergence Bounds]
The symbols $\varepsilon_{\mathrm{num}}$ and $\varepsilon_{\mathrm{tol}}$ in this appendix denote implementation hyperparameters used for
numerical stability and uniform-reward detection. They are unrelated to the divergence upper bound $\epsilon$ in \Cref{def:max-div}.
\end{remark}

\begin{enumerate}
    \item \textbf{Sum threshold:} If $\sum_{(i,t)\in\mathcal{P}} A_{i,t} < \varepsilon_{\mathrm{num}}$ or
    $-\sum_{(i,t)\in\mathcal{N}} A_{i,t} < \varepsilon_{\mathrm{num}}$ (default $\varepsilon_{\mathrm{num}} = 10^{-8}$), normalization is
    skipped and the original advantages are returned.

    \item \textbf{Scale clamping:} $\alpha$ and $\beta$ are clamped to $[\varepsilon_{\mathrm{num}}, s_{\max}]$ (default $s_{\max} = 10$) to prevent extreme scaling.

    \item \textbf{Intermediate overflow protection:} The quantity
    $\kappa^2 \sum_{(i,t)\in\mathcal{N}} A_{i,t}^2$ (where $\kappa$ is defined in \Cref{def:adaptive-norm}) is clamped to $10^8$ before
    computing $\alpha$.

    \item \textbf{Finiteness check:} If $\alpha$ or $\beta$ is NaN or $\pm\infty$ after computation, normalization is skipped.
\end{enumerate}

These safeguards may cause the normalized advantages to deviate slightly from the exact empirical constraints in
\Cref{def:adaptive-norm}. These thresholds are heuristic defaults; formal validation is deferred to the experimental evaluation.

\textbf{Fallback conditions.} Normalization is skipped entirely when:
\begin{itemize}
    \item All advantages have the same sign ($\mathcal{P} = \emptyset$ or $\mathcal{N} = \emptyset$), indicating the group has uniform quality and the leave-one-out-shaped advantages are already meaningful.
    \item The uniform scale mode (\Cref{app:uniform-scale}) is active and the group has uniform rewards.
\end{itemize}


\subsection{Uniform Scale Mode}
\label[appsec]{app:uniform-scale}

The uniform scale mode is an optional technique to improve sample utilization. When all $n$ samples for a prompt have identical rewards (all correct or all incorrect), the leave-one-out baseline yields $\tilde{r}_i = 0$ for all $i$, eliminating the gradient signal. Uniform scale mode recovers this signal.

\begin{definition}[Uniform Scale]
For prompt groups where $\mathrm{std}(\{r_1, \ldots, r_n\}) < \varepsilon_{\mathrm{tol}}$ (uniform-reward groups), the shaped reward is set to $\tilde{r}_i = r_i / n$, and the adaptive normalization (\Cref{sec:adaptive-norm}) is skipped.
\end{definition}

\begin{proposition}
Under uniform scale mode, the gradient for uniform-reward groups is proportional to $r_i \sum_t \nabla_\theta \log \pitheta(y_{i,t}|c_{i,t})$, which pushes the policy toward all sampled responses when $r_i > 0$ (all correct) and away from them when $r_i < 0$ (all incorrect), preserving gradient signal that the leave-one-out baseline would otherwise eliminate.
\end{proposition}

\begin{proof}
With $\tilde{r}_i = r_i/n$ and no normalization, the sample-$i$ contribution to the REINFORCE gradient is proportional to
\[
    \frac{r_i}{n} \sum_t \nabla_\theta \log \pitheta(y_{i,t}\mid c_{i,t}).
\]
Hence $\sign(r_i)$ determines the update direction: when $r_i > 0$ the policy increases the log-probability of the sampled tokens, and
when $r_i < 0$ it decreases them.
\end{proof}


\section{REINFORCE Pro: Proofs and Variants}

\subsection{Proof of \texorpdfstring{\Cref{thm:prefix-tighter}}{Theorem}}
\label[appsec]{app:prefix-proof}

We provide a complete proof of \Cref{thm:prefix-tighter} under the definitions in \Cref{sec:prefix-is}. For convenience, write the
log-threshold interval as
\begin{equation*}
    [\log(1-\epslow), \log(1+\epshigh)] = [-\tau_-, \tau_+],
    \qquad
    \tau_+ := \log(1+\epshigh),
    \qquad
    \tau_- := -\log(1-\epslow),
\end{equation*}
so that $\rho_t \in [1-\epslow,1+\epshigh]$ is equivalent to $\log\rho_t \in [-\tau_-,\tau_+]$.

\paragraph{Mask Definitions} The three masks compared in \Cref{thm:prefix-tighter} are:
\begin{itemize}
    \item \textbf{Token-level (IcePop / token-level ratio mask):}
    \begin{equation*}
        M_t^{\mathrm{tok}}
        := \mathbb{I}\!\big[\rho_t \in [1-\epslow,1+\epshigh]\big]
        = \mathbb{I}\!\big[\log\rho_t \in [-\tau_-,\tau_+]\big].
    \end{equation*}
    \item \textbf{Sequence-level (GSPO / sequence-level ratio gate):}
    \begin{equation*}
        M_t^{\mathrm{seq}}
        := \mathbb{I}\!\big[\log\rhoseq \in [-\tau_-,\tau_+]\big],
        \qquad
        \log\rhoseq := \frac{1}{T}\sum_{s=1}^{T}\log\rho_s,
    \end{equation*}
    for all $t$.
    \item \textbf{Prefix-level (Causal Trust Region proxy):}
    \begin{equation*}
        M_t^{\mathrm{pre}}
        := \mathbb{I}\!\big[\rhoprefix{t} \in [1-\epslow,1+\epshigh]\big]
        = \mathbb{I}\!\big[\log\rhoprefix{t} \in [-\tau_-,\tau_+]\big],
    \end{equation*}
    where $\rhoprefix{t}$ is defined in Eq.~\eqref{eq:prefix-is}.
\end{itemize}

\begin{proof}[Proof of \Cref{thm:prefix-tighter}]
\noindent\textbf{Part (a): Early deviation.}
Assume $\rho_1 \notin [1-\epslow,1+\epshigh]$ and $|\log\rho_t| \le \varepsilon$ for all $t>1$, with
$0 \le \varepsilon \le \min(\tau_+,\tau_-)$. Then for every $t>1$,
\begin{equation*}
    \log\rho_t \in [-\varepsilon,\varepsilon] \subseteq [-\tau_-,\tau_+],
\end{equation*}
so $M_t^{\mathrm{tok}}=1$ for all $t>1$, while $M_1^{\mathrm{tok}}=0$ (since $\rho_1 \notin [1-\epslow,1+\epshigh]$). Hence token-level
IcePop masks only position $t=1$.

\smallskip
For the prefix mask, note first that $M_1^{\mathrm{pre}}=0$ because $\rhoprefix{1}=\rho_1\notin[1-\epslow,1+\epshigh]$. To quantify how
long the rejection can persist, use Eq.~\eqref{eq:prefix-is}:
\begin{equation*}
    \log\rhoprefix{t}
    = \frac{1}{t}\sum_{s=1}^{t} \log\rho_s
    = \frac{1}{t}\left(\log\rho_1 + \sum_{s=2}^{t}\log\rho_s\right).
\end{equation*}
If $\log\rho_1>\tau_+$, then $\log\rho_s \ge -\varepsilon$ for all $s\ge2$, hence $\sum_{s=2}^{t}\log\rho_s \ge -(t-1)\varepsilon$ and therefore
\begin{align*}
    \log\rhoprefix{t}
    &\ge \frac{1}{t}\big(\log\rho_1-(t-1)\varepsilon\big)
    = \frac{\log\rho_1+\varepsilon}{t} - \varepsilon.
\end{align*}
Thus, if $t < (\log\rho_1+\varepsilon)/(\tau_+ + \varepsilon)$, then $\log\rhoprefix{t}>\tau_+$ and hence $M_t^{\mathrm{pre}}=0$.
The lower-violation case $\log\rho_1<-\tau_-$ is symmetric: since $\log\rho_s \le \varepsilon$ for $s\ge2$, we have
$\sum_{s=2}^{t}\log\rho_s \le \varepsilon(t-1)$ and therefore
\begin{align*}
    \log\rhoprefix{t}
    &\le \frac{1}{t}\big(\log\rho_1+\varepsilon(t-1)\big)
    = \frac{\log\rho_1-\varepsilon}{t} + \varepsilon.
\end{align*}
If $t < (-\log\rho_1+\varepsilon)/(\tau_-+\varepsilon)$, then $\log\rhoprefix{t} < -\tau_-$ and hence $M_t^{\mathrm{pre}}=0$.
This proves the sufficient conditions in \Cref{eq:early-upper-sufficient,eq:early-lower-sufficient}.

\par
\noindent\textbf{Part (b): Late deviation.}
Assume there exists $t^*\in\{1,\ldots,T\}$ such that $\rho_{t^*}\notin[1-\epslow,1+\epshigh]$ and $|\log\rho_t|\le \varepsilon$
for all $t\neq t^*$, with
$0 \le \varepsilon \le \min(\tau_+,\tau_-)$. For any $t<t^*$, all active log-ratios in the prefix satisfy $\log\rho_s \in [-\tau_-,\tau_+]$.
Since $\log\rhoprefix{t} = \frac{1}{t}\sum_{s=1}^{t}\log\rho_s$ is an average of values in $[-\tau_-,\tau_+]$, it follows that
$\log\rhoprefix{t} \in [-\tau_-,\tau_+]$, and hence $M_t^{\mathrm{pre}}=1$ for all $t<t^*$. Therefore prefix masking can only occur
for positions $t\ge t^*$, which implies
\begin{equation*}
    \big|\{t : M_t^{\mathrm{pre}} = 0\}\big| \le T - t^* + 1.
\end{equation*}
The sequence-level IS mask $M_t^{\mathrm{seq}}$ is constant across positions by definition, so it either rejects all tokens or rejects none.

For the claimed regime where prefix rejects but sequence-level accepts, consider the pure single-spike case where $\rho_t=1$ for
$t\neq t^*$ and $\rho_{t^*}>1$. Then
\[
    \log\rhoseq = \frac{1}{T}\log\rho_{t^*},
    \qquad
    \log\rhoprefix{t^*} = \frac{1}{t^*}\log\rho_{t^*}.
\]
Since $t^* \le T$ and $\log\rho_{t^*}>0$, we have $\log\rhoprefix{t^*} \ge \log\rhoseq$. Thus whenever
\begin{equation*}
    \frac{1}{t^*}\log\rho_{t^*} > \tau_+
    \quad\text{and}\quad
    \frac{1}{T}\log\rho_{t^*} \le \tau_+,
\end{equation*}
we obtain $M_{t^*}^{\mathrm{pre}}=0$ while $M_t^{\mathrm{seq}}=1$ for all $t$. (The lower-threshold case is analogous with $-\tau_-$.)

\par
\noindent\textbf{Part (c): Monotone violation.}
If $\log\rho_s > \tau_+$ for all $s$, then for every $t$ the prefix average satisfies $\log\rhoprefix{t} > \tau_+$, since it is an
average of values each strictly larger than $\tau_+$. Hence $M_t^{\mathrm{pre}}=0$ for all $t$. The sequence-level average
$\log\rhoseq$ is also strictly larger than $\tau_+$, so $M_t^{\mathrm{seq}}=0$ for all $t$. The lower-violation case $\log\rho_s < -\tau_-$
is symmetric.
\end{proof}

\subsection{Prefix Causal Trust Region Mechanism Bounds}
\label[appsec]{app:pre-causal-tr}

This subsection proves \Cref{lem:prefix-density-ratio,lem:tv-prefix-ratio,thm:pre-causal-mechanism}, which formalize a per-position
mechanism interpretation of prefix Causal Trust Region masking.

\begin{proof}[Proof of \Cref{lem:prefix-density-ratio}]
Fix $t\in\{1,\ldots,T\}$ and a reachable context $c_{t+1}=(x,y_{\le t})$ with $d_{t+1}^{\piroll}(c_{t+1})>0$. By the definition of the
context visitation distribution, for any policy $\pi$,
\begin{align*}
    d_{t+1}^{\pi}(c_{t+1})
    &= P(x)\,P^{\pi}(y_{\le t}\mid x)
    \\
    &= P(x)\prod_{s=1}^{t}\pi(y_s\mid c_s),
\end{align*}
where $c_s=(x,y_{<s})$ and the second line is the autoregressive factorization.
Under Assumption~\ref{asm:support}, the ratio $d_{t+1}^{\pitheta}(c_{t+1})/d_{t+1}^{\piroll}(c_{t+1})$ is well-defined for all such
contexts. Therefore,
\begin{align*}
    \frac{d_{t+1}^{\pitheta}(c_{t+1})}{d_{t+1}^{\piroll}(c_{t+1})}
    &=
    \prod_{s=1}^{t} \frac{\pitheta(y_s\mid c_s)}{\piroll(y_s\mid c_s)}
    \\
    &= \prod_{s=1}^{t}\rho_s
    = W_t,
\end{align*}
as claimed.
\end{proof}

\begin{proof}[Proof of \Cref{lem:tv-prefix-ratio}]
Fix $t\in\{1,\ldots,T\}$. By definition of total variation distance,
\begin{align*}
    \bigl\|d_{t+1}^{\pitheta} - d_{t+1}^{\piroll}\bigr\|_{\mathrm{TV}}
    &=
    \frac{1}{2}\sum_{c_{t+1}} \bigl|d_{t+1}^{\pitheta}(c_{t+1}) - d_{t+1}^{\piroll}(c_{t+1})\bigr|.
\end{align*}
By \Cref{lem:prefix-density-ratio}, for every reachable $c_{t+1}$ with $d_{t+1}^{\piroll}(c_{t+1})>0$,
\begin{equation*}
    d_{t+1}^{\pitheta}(c_{t+1})
    =
    d_{t+1}^{\piroll}(c_{t+1})\,W_t.
\end{equation*}
Substituting this into the previous display yields
\begin{align*}
    \bigl\|d_{t+1}^{\pitheta} - d_{t+1}^{\piroll}\bigr\|_{\mathrm{TV}}
    &=
    \frac{1}{2}\sum_{c_{t+1}} d_{t+1}^{\piroll}(c_{t+1})\,\bigl|W_t - 1\bigr|
    \\
    &=
    \frac{1}{2}\E_{c_{t+1}\sim d_{t+1}^{\piroll}}\!\left[\bigl|W_t - 1\bigr|\right],
\end{align*}
which proves the claim.
\end{proof}

\begin{proof}[Proof of \Cref{thm:pre-causal-mechanism}]
Fix $t\in\{1,\ldots,T\}$. Recall that $\tau_+ := \log(1+\epshigh)$ and $\tau_- := -\log(1-\epslow)$.

\smallskip
\noindent\textbf{Step 1: Rewrite the acceptance event.}
By definition of the prefix mask in Eq.~\eqref{eq:prefix-mask},
\begin{equation*}
    M_t^{\mathrm{pre}}=1
    \quad\Longleftrightarrow\quad
    \log\rhoprefix{t}\in[-\tau_-,\tau_+].
\end{equation*}
Using Eq.~\eqref{eq:prefix-is}, this is equivalent to the cumulative log-ratio constraint
\begin{equation*}
    -t\tau_- \le \sum_{s=1}^{t}\log\rho_s \le t\tau_+.
\end{equation*}

\smallskip
\noindent\textbf{Step 2: Convert to a bound on the prefix density ratio.}
Recall that $W_t = \prod_{s=1}^{t}\rho_s$. Equivalently,
\begin{equation*}
    W_t = \exp\!\Big(\sum_{s=1}^{t}\log\rho_s\Big).
\end{equation*}
Therefore, the previous display implies that, on $\{M_t^{\mathrm{pre}}=1\}$,
\begin{equation*}
    e^{-t\tau_-} \le W_t \le e^{t\tau_+}.
\end{equation*}

\smallskip
\noindent\textbf{Step 3: Bound the ratio residual and take expectations.}
If a scalar $w$ lies in an interval $[a,b]$ with $0<a\le b$, then $|w-1|\le \max\{b-1,1-a\}$. Applying this with
$a=e^{-t\tau_-}$ and $b=e^{t\tau_+}$ yields that on $\{M_t^{\mathrm{pre}}=1\}$,
\begin{equation*}
    \bigl|W_t-1\bigr|
    \le
    \max\!\big\{e^{t\tau_+}-1,\;1-e^{-t\tau_-}\big\}.
\end{equation*}
Multiplying by $M_t^{\mathrm{pre}}$ and taking expectations under $c_{t+1}\sim d_{t+1}^{\piroll}$ gives
\begin{align*}
    \E_{c_{t+1}\sim d_{t+1}^{\piroll}}\!\left[M_t^{\mathrm{pre}}\,\bigl|W_t-1\bigr|\right]
    &\le
    \max\!\big\{e^{t\tau_+}-1,\;1-e^{-t\tau_-}\big\}\,
    \E_{c_{t+1}\sim d_{t+1}^{\piroll}}\!\left[M_t^{\mathrm{pre}}\right]
    \\
    &\le
    \max\!\big\{e^{t\tau_+}-1,\;1-e^{-t\tau_-}\big\},
\end{align*}
which completes the proof.
\end{proof}

\subsection{Sub-Gaussian Strengthening: Per-Position Bounds via Prefix Density Ratios}
\label[appsec]{app:subgaussian-perpos}

This subsection proves \Cref{lem:wt-second-moment,cor:tv-prefix-subgaussian,thm:per-position-error-subgaussian}, which strengthen the
prefix density-ratio mechanism view with explicit per-position bounds under a conditional concentration assumption.

\begin{proof}[Proof of \Cref{lem:wt-second-moment}]
Fix $t\in\{1,\ldots,T\}$. Throughout this proof, expectations are taken under the rollout distribution
$c_{t+1}\sim d_{t+1}^{\piroll}$ (equivalently, $(x,y_{\le t})$ generated by $\piroll$).
Recall $W_t=\prod_{s=1}^{t}\rho_s$.

\smallskip
\noindent\textbf{Step 1: Decompose log-ratios into mean + centered increments.}
For each $s\in\{1,\ldots,t\}$, define
\begin{equation*}
    \mu_s := \E\!\left[\log\rho_s\mid c_s\right],
    \qquad
    X_s := \log\rho_s - \mu_s.
\end{equation*}
Under Assumption~\ref{asm:support}, the conditional expectation is well-defined, and moreover
\begin{equation*}
    \mu_s
    =
    \E_{y_s\sim \piroll(\cdot|c_s)}\!\left[\log\frac{\pitheta(y_s\mid c_s)}{\piroll(y_s\mid c_s)}\right]
    =
    -\DKL\bigl(\piroll(\cdot|c_s)\,\|\,\pitheta(\cdot|c_s)\bigr)
    \le 0.
\end{equation*}
Therefore,
\begin{align*}
    W_t^2
    &= \exp\!\Big(2\sum_{s=1}^{t}\log\rho_s\Big)
    \\
    &= \exp\!\Big(2\sum_{s=1}^{t}\mu_s\Big)\cdot \exp\!\Big(2\sum_{s=1}^{t}X_s\Big)
    \\
    &\le \exp\!\Big(2\sum_{s=1}^{t}X_s\Big),
\end{align*}
and hence
\begin{equation*}
    \E\!\left[W_t^2\right]
    \le
    \E\!\left[\exp\!\Big(2\sum_{s=1}^{t}X_s\Big)\right].
\end{equation*}

\smallskip
\noindent\textbf{Step 2: Control the MGF of the adapted sum by tower property.}
Let $\mathcal{F}_s:=\sigma(x,y_{\le s})$ denote the natural filtration.
Since $c_s=(x,y_{<s})$ is $\mathcal{F}_{s-1}$-measurable and $X_s$ depends only on $(c_s,y_s)$, we have
\begin{equation*}
    \E\!\left[\exp(2X_s)\mid \mathcal{F}_{s-1}\right]
    =
    \E\!\left[\exp(2X_s)\mid c_s\right].
\end{equation*}
By \Cref{asm:subgaussian-logratio} with $\lambda=2$,
\begin{equation*}
    \E\!\left[\exp(2X_s)\mid c_s\right]
    \le \exp\!\left(\frac{2^2\sigma^2}{2}\right)
    = \exp(2\sigma^2).
\end{equation*}
Therefore, applying the tower property yields
\begin{align*}
    \E\!\left[\exp\!\Big(2\sum_{s=1}^{t}X_s\Big)\right]
    &=
    \E\!\left[
        \exp\!\Big(2\sum_{s=1}^{t-1}X_s\Big)\cdot \E\!\left[\exp(2X_t)\mid \mathcal{F}_{t-1}\right]
    \right]
    \\
    &\le
    \exp(2\sigma^2)\,\E\!\left[\exp\!\Big(2\sum_{s=1}^{t-1}X_s\Big)\right].
\end{align*}
Iterating this inequality gives
\begin{equation*}
    \E\!\left[\exp\!\Big(2\sum_{s=1}^{t}X_s\Big)\right]
    \le
    \exp(2\sigma^2 t).
\end{equation*}
Combining with Step~1 completes the proof.
\end{proof}

\begin{proof}[Proof of \Cref{cor:tv-prefix-subgaussian}]
Fix $t\in\{1,\ldots,T\}$. By \Cref{lem:tv-prefix-ratio},
\begin{equation*}
    \bigl\|d_{t+1}^{\pitheta} - d_{t+1}^{\piroll}\bigr\|_{\mathrm{TV}}
    =
    \frac{1}{2}\E\!\left[\bigl|W_t-1\bigr|\right].
\end{equation*}
By Cauchy--Schwarz, $\E[|Z|]\le \sqrt{\E[Z^2]}$, so
\begin{equation*}
    \E\!\left[\bigl|W_t-1\bigr|\right]
    \le
    \sqrt{\E\!\left[(W_t-1)^2\right]}.
\end{equation*}
Expanding the square yields
\begin{equation*}
    \E\!\left[(W_t-1)^2\right]
    =
    \E\!\left[W_t^2\right] - 2\E[W_t] + 1.
\end{equation*}
By \Cref{lem:prefix-density-ratio}, $W_t = d_{t+1}^{\pitheta}(c_{t+1})/d_{t+1}^{\piroll}(c_{t+1})$, so
\begin{equation*}
    \E[W_t]
    =
    \sum_{c_{t+1}} d_{t+1}^{\piroll}(c_{t+1})\frac{d_{t+1}^{\pitheta}(c_{t+1})}{d_{t+1}^{\piroll}(c_{t+1})}
    =
    \sum_{c_{t+1}} d_{t+1}^{\pitheta}(c_{t+1})
    =
    1.
\end{equation*}
Together with \Cref{lem:wt-second-moment}, this implies
\begin{equation*}
    \E\!\left[(W_t-1)^2\right]
    \le \exp(2\sigma^2 t) - 1.
\end{equation*}
Substituting into the first display gives the claim.
\end{proof}

\begin{proof}[Proof of \Cref{thm:per-position-error-subgaussian}]
Recall the error decomposition in Eq.~\eqref{eq:error-decomp}:
\begin{equation*}
    |\mathrm{Error}(\pitheta)|
    \le
    \sum_{t=1}^{T} 2\|g_t\|_\infty \cdot \|d_t^{\pitheta} - d_t^{\piroll}\|_{\mathrm{TV}}.
\end{equation*}

\smallskip
\noindent\textbf{Step 1: Bound the advantage factor by bounded rewards.}
Fix $t$ and a context $c_t$. By definition,
\begin{equation*}
    g_t(c_t) := \E_{y_t \sim \pitheta(\cdot\mid c_t)}\!\big[A_t^{\piroll}(c_t, y_t)\big],
    \qquad
    A_t^{\piroll}(c_t, y_t)
    :=
    \E_{\piroll}\!\big[R(x,y)\mid c_t, y_t\big] - \E_{\piroll}\!\big[R(x,y)\mid c_t\big].
\end{equation*}
Under bounded rewards $|R(x,y)|\le R_{\max}$, both conditional expectations lie in $[-R_{\max},R_{\max}]$, hence
$|A_t^{\piroll}(c_t,y_t)|\le 2R_{\max}$ and consequently $|g_t(c_t)|\le 2R_{\max}$. Therefore $\|g_t\|_\infty \le 2R_{\max}$.

\smallskip
\noindent\textbf{Step 2: Apply the per-position TV bound.}
For each $t\in\{1,\ldots,T\}$, observe that $d_t$ is a length-$t$ context distribution, i.e., it corresponds to a length-$(t-1)$ prefix.
Thus \Cref{cor:tv-prefix-subgaussian} with index $(t-1)$ gives
\begin{equation*}
    \|d_t^{\pitheta} - d_t^{\piroll}\|_{\mathrm{TV}}
    \le
    \frac{1}{2}\sqrt{\exp(2\sigma^2 (t-1)) - 1}.
\end{equation*}

\smallskip
\noindent\textbf{Step 3: Combine.}
Substituting the bounds from Steps~1--2 into the error decomposition yields
\begin{align*}
    |\mathrm{Error}(\pitheta)|
    &\le
    \sum_{t=1}^{T} 2(2R_{\max})\cdot \frac{1}{2}\sqrt{\exp(2\sigma^2 (t-1)) - 1}
    \\
    &=
    2R_{\max}\sum_{t=1}^{T}\sqrt{\exp(2\sigma^2 (t-1)) - 1},
\end{align*}
which completes the proof.
\end{proof}

\subsection{Alternative Trust-Region Masking Variants}
\label[appsec]{app:mask-variants}

This appendix collects several masking variants that are compatible with the ratio setup in the main text
(\Cref{sec:offpolicy-problem}). Throughout, samples are generated by the behavior policy $\piroll$ and gradients are computed under the
training policy $\pitheta$. We write the per-token importance ratio as
\begin{equation*}
    \rho_t := \frac{\pitheta(y_t \mid c_t)}{\piroll(y_t \mid c_t)}.
\end{equation*}
We also reuse the prefix statistic $\rhoprefix{t}$ from \Cref{def:prefix-is}.
For thresholds $\epslow\in(0,1)$ and $\epshigh>0$, define the log-threshold interval
\begin{equation*}
    [\log(1-\epslow),\log(1+\epshigh)] = [-\tau_-,\tau_+],
    \qquad
    \tau_+ := \log(1+\epshigh),
    \qquad
    \tau_- := -\log(1-\epslow).
\end{equation*}

\paragraph{Variant I: Absorbing Prefix-Average Mask}

The main text uses a pointwise prefix gate at each position $t$. A more rejection-style variant enforces an \emph{absorbing} semantics:
once a prefix violates the threshold, all subsequent positions are rejected.

\begin{equation*}
    \widetilde{M}_t^{\mathrm{pre}}
    := \mathbb{I}\!\big[\rhoprefix{t} \in [1-\epslow,1+\epshigh]\big],
    \qquad
    M_t^{\mathrm{abs\text{-}pre}}
    := \prod_{u=1}^{t}\widetilde{M}_u^{\mathrm{pre}}.
\end{equation*}

\paragraph{Variant II: Prefix-Max Mask / Max-Filtering}

Max-based trust-region criteria can be expressed via a sample-based proxy $k_2(\rho)$:
\begin{equation*}
    k_2(\rho) := \tfrac{1}{2}(\log\rho)^2.
\end{equation*}
The corresponding prefix-max statistic and mask are
\begin{equation*}
    S_t^{\max} := \max_{1\le s\le t} k_2(\rho_s),
    \qquad
    M_t^{\mathrm{pre\text{-}max}} := \mathbb{I}\!\big[S_t^{\max} \le \delta_{\max}\big].
\end{equation*}
Equivalently, $M_t^{\mathrm{pre\text{-}max}}=1$ iff $\max_{s\le t}|\log\rho_s| \le \sqrt{2\delta_{\max}}$.

\paragraph{Variant III: Prefix-Score Mask / Bound-Driven}

Score-based masking controls a prefix-level aggregate of per-token ratio deviations. Define a nonnegative per-token deviation
\begin{equation*}
    a_t := |\rho_t - 1|
\end{equation*}
and deterministic nonnegative weights $(w_t)_{t\ge1}$ with $\sum_{s\le t} w_s > 0$. The prefix score is
\begin{equation*}
    \widetilde{W}_t
    := \frac{\sum_{s=1}^{t} w_s a_s}{\sum_{s=1}^{t} w_s},
\end{equation*}
and the corresponding mask is
\begin{equation*}
    M_t^{\mathrm{pre\text{-}score}} := \mathbb{I}\!\big[\widetilde{W}_t \le \delta_W\big].
\end{equation*}
A special case is the uniform-weight choice $w_s\equiv 1$, which yields $\widetilde{W}_T = \frac{1}{T}\sum_{t=1}^{T}|\rho_t-1|$ at the
full horizon.

\paragraph{Variant IV: Prefix Abnormal-Token Rate / TRM-Style}

TRM~\citep{li2025trm} uses per-token divergence estimates (or their sample-based proxies) to decide whether a trajectory lies inside a
trust region. We can adapt this idea to a prefix-level gate by counting \emph{abnormal} tokens in the prefix. Concretely, define the
abnormal-token indicator
\begin{equation*}
    B_t := \mathbb{I}\!\big[\Dkltok(c_t;\piroll,\pitheta) > \delta_{\mathrm{TRM}}\big],
\end{equation*}
and the prefix abnormal count and rate
\begin{equation*}
    N_t := \sum_{s=1}^{t} B_s,
    \qquad
    \widehat{p}_t := \frac{N_t}{t}.
\end{equation*}
Given a rate threshold $\xi\in[0,1]$, the corresponding prefix mask is
\begin{equation*}
    M_t^{\mathrm{pre\text{-}anom}}
    := \mathbb{I}\!\big[\widehat{p}_t \le \xi\big].
\end{equation*}
In practice, one may instantiate $B_t$ using TRM's computation method for $\Dkltok(c_t;\piroll,\pitheta)$; for example, via the
sample-based proxy $k_3(\rho):=\rho-1-\log\rho$, which satisfies
$\E_{\piroll}[k_3(\rho_t)\mid c_t]=\DKL(\piroll(\cdot\mid c_t)\,\|\,\pitheta(\cdot\mid c_t))$ under the ratio definition
$\rho_t=\pitheta/\piroll$ and support overlap.

\begin{lemma}[From Abnormal-Token Rate to a Prefix-Average Constraint]
\label{lem:anom-rate-implies-pre}
Fix a position $t\in\{1,\ldots,T\}$ and write $z_s := \log\rho_s$ for $s\le t$. Assume there exist finite constants
$\Lambda_+,\Lambda_->0$ such that
\begin{equation*}
    -\Lambda_- \le z_s \le \Lambda_+,
    \qquad
    \forall s\le t.
\end{equation*}
Let $k_3(\rho):=\rho-1-\log\rho$ and define the abnormal-token indicator and its prefix rate by
\begin{equation*}
    B_s := \mathbb{I}\!\big[k_3(\rho_s) > \delta_0\big],
    \qquad
    \widehat{p}_t := \frac{1}{t}\sum_{s=1}^{t} B_s,
    \qquad
    \delta_0>0.
\end{equation*}
Then every inlier token ($B_s=0$) satisfies $|z_s|\le \tau_0$, where $\tau_0:=\sqrt{2\delta_0}$. Moreover, if $\widehat{p}_t \le \xi$ for
some $\xi\in[0,1]$, then the prefix-average log-ratio obeys
\begin{equation*}
    \frac{1}{t}\sum_{s=1}^{t} \log\rho_s
    \in
    \Big[-\tau_0 - \xi(\Lambda_- - \tau_0),\;\tau_0 + \xi(\Lambda_+ - \tau_0)\Big].
\end{equation*}
In particular, choosing log-thresholds $(\tau_-,\tau_+)$ that satisfy
\begin{equation*}
    \tau_- \ge \tau_0 + \xi(\Lambda_- - \tau_0),
    \qquad
    \tau_+ \ge \tau_0 + \xi(\Lambda_+ - \tau_0)
\end{equation*}
ensures $\widehat{p}_t\le\xi$ implies the prefix-average constraint $\frac{1}{t}\sum_{s\le t}\log\rho_s\in[-\tau_-,\tau_+]$, and hence
$\rhoprefix{t}\in [e^{-\tau_-}, e^{\tau_+}]$.
\end{lemma}

\begin{proof}
Write $u := \log\rho$. Since $e^{u} \ge 1 + u + \tfrac{1}{2}u^2$ for all $u\in\R$, we have
\begin{equation*}
    k_3(\rho)
    = \rho - 1 - \log\rho
    = e^{u} - 1 - u
    \ge \tfrac{1}{2}u^2.
\end{equation*}
Therefore, $B_s=0$ implies $\tfrac{1}{2}z_s^2 \le \delta_0$, i.e., $|z_s|\le \sqrt{2\delta_0}=\tau_0$.

\smallskip
Let $N_t := \sum_{s=1}^{t} B_s$ so that $\widehat{p}_t = N_t/t \le \xi$. For the upper bound, split the sum into inliers and outliers:
\begin{equation*}
    \sum_{s=1}^{t} z_s
    \le
    (t-N_t)\,\tau_0 + N_t\,\Lambda_+,
\end{equation*}
since inliers satisfy $z_s \le \tau_0$ and outliers satisfy $z_s \le \Lambda_+$. Dividing by $t$ and using $N_t/t\le\xi$ yields
\begin{equation*}
    \frac{1}{t}\sum_{s=1}^{t} z_s
    \le
    \tau_0 + \xi(\Lambda_+ - \tau_0).
\end{equation*}
Similarly, using $z_s \ge -\tau_0$ for inliers and $z_s \ge -\Lambda_-$ for outliers gives
\begin{equation*}
    \frac{1}{t}\sum_{s=1}^{t} z_s
    \ge
    -\tau_0 - \xi(\Lambda_- - \tau_0).
\end{equation*}
The final implication to $\rhoprefix{t}$ follows from $\log\rhoprefix{t} = \frac{1}{t}\sum_{s\le t}\log\rho_s$.
\end{proof}

## 计划：TRM 主对齐 + DPPO 式“正文讲结论、附录给细节”的严谨重写与排版统一（全篇 + 全部证明扩写）

### 摘要（你要的最终效果）

- 数学正确性优先：所有主张可追溯到清晰的定义、引理、定理与证明链路；证明中每一步都有合法的等式/不等式理由（tower property、Pinsker、chain rule、induction
等）。
- 风格主对齐 TRM：定理/证明语言、段落切分、Step/Case/Bound 组织方式、公式隔离策略尽量复刻 tex/literature/TRM/main_arxiv.tex。
- 结构借鉴 DPPO：正文避免堆推导，在正文保留关键定义 + 承重公式 + 高层逻辑；所有细推导、长证明、技术变体统一集中在附录（并且用统一模板组织）。
- 保守符号策略：保留你现在的核心符号体系（\piroll,\pitheta,\mathcal{L}、token/sequence/prefix 三层统计量），只修复不一致、增强可读性与严谨性，不做“重命名
式改论文”。

———

## Phase 1 — 参考文献风格与记号规范抽取（输出可执行的 Style Spec）

### 1.1 必读与抽样范围（来自 tex/literature/）

1. TRM 主文本与附录证明（重点）
    - tex/literature/TRM/main_arxiv.tex
2. DPPO 的组织与附录风格（重点）
    - tex/literature/DPPO/example_paper.tex
    - 以及 tex/literature/DPPO/paper/ 目录下正文与附录入口文件（你明确要求要深入 paper/）
3. GSPO 的 ratio 与长度归一化推导写法（用于对齐表达方式）
    - tex/literature/GSPO/colm2024_conference.tex
4. Theory 三篇（你要求必须阅读，且作者高度重合，需判断 TRM 与 MIS 关系）
    - tex/literature/Theory/1-Why Off-Policy Breaks RL An SGA Analysis Framework.md
    - tex/literature/Theory/2-Applying the SGA Framework Token v.s. Sequence-level Correction.md
    - tex/literature/Theory/3-Trust Region Optimization via Sequence Masking.md

### 1.2 从 TRM/DPPO 提取的“硬规范”（要落到代码变更）

产出一份内部规范（不一定要新建文件；也可以直接作为执行 checklist）：

- 定理与证明语言模板（TRM 风格）
    - 证明开头：一句话说明要证明什么 + 证明路线（“We establish Bound 1–5…”, “We consider Case A/B…”, “We proceed by induction…”）。
    - 证明主体：用 \textbf{Bound k: ...} / \textbf{Step k: ...} / \emph{Base case...} / \emph{Inductive step...}。
    - 公式推导：集中用 align/align*，每行一条变形，必要时 \nonumber，并在行尾用短语解释（例如 “(tower property)”, “(Pinsker)”, “(definition of TV)”）。
- 公式与解释的隔离策略
    - 超过“简单定义/一行等式”的数学内容不放在句子里；先桥接句，再 display math，再解释句。
- 引用与交叉引用
    - 方程：统一 Eq.~\eqref{...}。
    - 定理/引理/定义/附录：统一 \Cref{...}（你已有 cleveref；附录用 appsec 类型 label 已就绪）。
- 标题与术语大小写/连字符策略
    - 文中：token-level, sequence-level, prefix-level, off-policy 全部小写+连字符。
    - 标题：Title Case，但保留连字符，例如 Token-Level, Sequence-Level。
    - 统一 “trust region” 是否大写：正文一般 trust region，术语名如 Trust Region Masking (TRM) 首次大写。
- 数学符号来源与宏
    - 以 tex/math_commands.tex 作为“符号库参考”，把论文实际用到的符号宏收敛到 tex/math.tex（避免引入 math_commands.tex 里会覆写 \eqref 的危险宏）。
    - 任何新符号先定义宏再使用，避免局部 ad-hoc。

———

## Phase 2 — 对草稿的诊断（输出带精确位置的缺陷清单）

对 tex/main.tex 及其输入文件（tex/main/*.tex）做系统诊断，按严重性分组：

### 2.1 数学严谨性风险（必须修）

- 定义域/假设缺失：例如阈值区间、support overlap、有限长度、reward boundedness 是否在所有需要处被调用。
- 等价性/近似性表述不够精确：例如 \mathcal{L}_{\piroll} vs \tilde{\mathcal{L}}_{\piroll} 的关系，需要严格区分 “equivalent reformulation” 与
“implementation approximation”。
- proof sketch 与 full proof 不一致：正文 sketch 中引用的关键不等式是否在附录完整证明里出现，且符号一致。
- 因果性/上下文漂移的逻辑链：token-level mask 何以不能阻止后续 context shift，需要把关键 lemma/remark（类似 TRM coupling/propagation 论证）放到合适的位置
并给出可引用的证明入口。

### 2.2 记号一致性问题（必须修）

- 环境类型与 label 前缀不一致（例如 remark 环境却用 prop: label）。
- 同一对象多种写法（例如 prefix gate / mask / statistic 的上标或语义描述）。
- 宏未统一（例如 indicator、TV/KL 的记法、d_t^\pi 的上下标次序等）。

### 2.3 排版与可读性缺陷（必须修）

- “复杂公式 + 解释句”混排在同一段同一句中，阅读负担重。
- 长公式单行塞进 equation 导致 overfull 风险：要拆成 align 并对齐关键项。
- proof 里缺少显式的 step/case 标识，导致结构不如 TRM。

诊断产物形式

- 输出一个列表（供实现阶段逐条关闭），每条包含：
    - tex/main/<file>.tex:line
    - 问题类型：Rigor / Notation / Typesetting
    - 修复策略：一句话说明会怎么改
    - 影响范围：是否会触及引用、label、宏、附录结构

———

## Phase 3 — 严谨重写与美学对齐（逐文件、可验收的实施方案）

> 目标是“写法像 TRM，结构像 DPPO”，但不改变你的核心贡献与逻辑。

### 3.1 统一宏与符号层（先做，避免后面反复改）

文件：tex/math.tex

- 建立一套“论文实际使用的最小宏集合”，从 tex/math_commands.tex 里择取思想但不直接 \input。
- 明确禁止引入会覆写标准命令的宏（尤其是 math_commands.tex 里对 \eqref 的重定义）。
- 对 indicator 建议统一一个宏（例如 \newcommand{\ind}{\mathbb{I}} 或 \newcommand{\ind}[1]{\mathbb{I}[#1]}），并把全文 \mathbb{I}[\cdot] 统一成 \ind[\cdot]
（减少视觉噪声，贴近 TRM 常见写法）。
- 检查 prefix 相关宏是否与正文一致：
    - 你现在 mask 上标用 \mathrm{pre}；prefix statistic 宏 \rhoprefix{t} 当前在 tex/math.tex 是 ^{\mathrm{prefix}}。
    - 保守策略下的改法（推荐）：不改宏名 \rhoprefix{t}，但把其上标改为 ^{\mathrm{pre}}，实现“视觉一致”，不触动正文大规模替换。

文件：tex/env.tex

- 对齐 TRM 常用设置：
    - 保持 amsmath,amssymb,amsthm,mathtools,thmtools,cleveref（已具备）。
    - 若引入 \ind 并需要 \mathbbm{1} 才像某些 paper：再决定是否加 bbm；但默认先不加（保守、可移植）。
- theorem 环境保持当前结构，但要求：
    - 仅用 theorem/lemma/proposition/corollary/definition/assumption/remark 这套，避免自造环境名。
    - proof 语言统一采用 TRM 的 Step/Case 风格（靠内容改，不靠环境改）。

### 3.2 正文结构与语言统一（全篇重写，数学段落优先）

#### tex/main/1-intro.tex

- 对齐 TRM 的引入方式：
    - 先给问题：long-horizon + mismatch + critic-free 的挑战。
    - 再给贡献列表：每条贡献一句话，避免口语化。
    - 所有 claim 尽量落到“可证明/可定义/可操作”的对象上。

#### tex/main/3-preliminaries.tex

重写目标：像 TRM 那样“先设定、再 surrogate、再 error decomposition、再 divergence building blocks、再 existing methods（只留定义）”。

- 将“Existing IS Correction Methods”严格限制为定义与统一记号，不做对比评论（你此前也希望如此）。
- 对 \mathcal{L}_{\piroll} 给出 TRM 式清晰层级：
    1. per-step advantage 定义（display）
    2. surrogate 定义（display，必要时拆 align）
    3. error 定义与 decomposition（display）
- 所有复杂等式用 align，并在每步后用短括号解释（tower property/definition）。

#### tex/main/4-method.tex

重写目标：把“REINFORCE Max”与“REINFORCE Pro”写得像 TRM 的方法节一样干净、可引用、可证明；把细证明推到附录（DPPO 方式）。

- REINFORCE Max
    - Adaptive normalization 的 closed-form：正文只保留最终 (\alpha,\beta) 结果（你明确要求），推导过程移到附录，并按 TRM 证明风格扩写。
    - “Connection to Response Length”：改成更严格的命题结构（但仍用 remark 即可），把“长度进入统计量”的推导用 align 展开，避免长句内塞推导。
- REINFORCE Pro
    - “Limitations of Existing Methods”：模仿 TRM 的写法，改为两个并列的结构化小节（即便仍在 method 中）：
        - token-level fails（因果结构/上下文漂移）
        - sequence-level fails（positional dilution）
    - Theorem~\ref{thm:prefix-tighter}：
        - 正文保留 theorem statement + 非冗长 proof sketch（DPPO 风格：正文讲直觉与关键不等式入口）。
        - proof sketch 也要 TRM 化：明确 Part (a)/(b)/(c)，每部分给出 3–6 行 align 作为承重推导，不在句子里讲算式。
- 复杂公式隔离：例如 acceptance interval、log-threshold 等全部单独 display，前后用桥接句过渡。

#### tex/main/5-theory.tex

重写目标：像 TRM 那样把 “unified view” 写成可复用的结构，同时保持你已有的两段 comparison 拆分。

- 继续保持两个 comparison subsections：
    1. advantage estimation methods
    2. IS correction methods
- 把所有对比文字变成 “Definition → Mechanism → Consequence (bias/variance/causality)” 的三段式，每段中只放一个关键 display 公式，避免连环 inline math。
- Algorithm 部分：把逐行解释写得更像 TRM 的算法说明（Line-by-line + “We emphasize that…”）。

### 3.3 附录证明全面扩写（TRM 证明语言 + DPPO 附录组织）

文件：tex/main/appendix.tex

目标：把附录变成“可审稿的证明仓库”，每个 theorem/lemma 都有统一模板入口，且推导步骤充分展开。

#### 3.3.1 附录整体组织（DPPO 式）

把附录的 proof 部分重排为类似 TRM 的结构（你现在已经有 roadmap，可以继续强化）：

- Appendix Roadmap
- Proofs of Main Results
- Proofs of Supporting Lemmas
- Implementation/Engineering Notes (optional)（仍然保守，不扩展科学结论）

#### 3.3.2 每个 proof 的强制模板（逐条落实）

对 appendix.tex 内每个证明，强制改成同一模板（TRM 风格）：

1. Goal statement：一句话说明要证什么（引用 \Cref{...}）。
2. Setup：列出会用到的定义/阈值/符号（display 集中给出，不散落）。
3. Derivation：主体用 align 展开，每一步标注理由：
    - (definition of \rho_t)
    - (Pinsker)
    - (KL chain rule)
    - (tower property)
    - (triangle inequality)
4. Case/Part structure：如果 theorem 有 (a)(b)(c)，proof 也按 (a)(b)(c) 分块，并在块内再用 Step/Bound。
5. Conclusion line：一句话 “This completes the proof.”

重点扩写对象（必须做）：

- \Cref{thm:prefix-tighter} 的 full proof（目前已有，但需要更 TRM 化、更细分）。
- Adaptive normalization 推导（如果目前在正文或附录里过简）：把解方程的过程完整写出，但把正文只留最终结果。
- 任何正文引用过的 lemma/remark（例如 context shift propagation）都要有可追溯入口：要么给简短证明，要么给“直接引用 TRM 的 lemma + 指向原文位置”的标准写法
（并避免抄原文句子）。

———

## 验收标准（实现后必须全部通过）

### A. 编译闸门

### B. 排版与写作规范
- 全文不存在把复杂推导塞进句子里的情况：复杂数学必须 display。
- proof 均具备 Step/Case/Bound 风格结构，且推导使用 align/align*，不混用 code span。
- token-level/sequence-level/prefix-level 连字符与大小写策略全篇一致。

- tex/math.tex 中的宏是论文实际用到的最小集合；不引入 tex/math_commands.tex 的危险重定义（尤其 \eqref）。
- prefix mask/statistic 的上标在视觉上自洽（保守策略：mask 与 prefix statistic 都用 \mathrm{pre}）。
- 所有 indicator 推荐统一用 \ind（若采纳该宏），避免散落 \mathbb{I}。

### D. 自动化检索（实现时用 rg）

- 检查“复杂公式不该 inline”的典型残留：
    - 搜索含多重 \sum/\prod 的 inline（通过模式检索定位再人工判断）。
- 检查环境-label 前缀一致性：
    - remark 不再使用 prop: 等误导前缀。
- 检查无 Unicode 数学符号误入（例如直接的 π）：
    - rg -n \"π\" tex/main tex/math.tex tex/env.tex 结果为 0。

———

## 提交与迭代策略（实现阶段执行）

为了可审阅与可回滚，建议拆成 4 个 commit（每个都要求 compile 通过）：

## 明确假设（按你的回答锁定）

- Scope：你要求“1/2/3 都要满足”，因此执行为：全篇风格统一 + 全部 proof 扩写 + 数学段落最严谨。
- Primary style：TRM-First；DPPO 用于“正文少推导、附录多细节”的组织方式与措辞习惯借鉴。